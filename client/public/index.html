<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Website Decompiler Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-btn {
            padding: 12px 20px;
            border: 2px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 5px;
            font-weight: 600;
            transition: all 0.3s;
            color: #667eea;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .tab-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3em;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }

        .upload-area:hover, .upload-area.drag-over {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-text {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .upload-subtext {
            color: #999;
            font-size: 0.9em;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            margin-top: 10px;
            transition: all 0.3s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .results {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-top: 20px;
            display: none;
        }

        .results.show {
            display: block;
        }

        .results h3 {
            color: #667eea;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .result-section {
            margin-bottom: 20px;
        }

        .result-section h4 {
            color: #555;
            margin-bottom: 10px;
            font-size: 1.05em;
        }

        .file-list {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9ff;
            border-radius: 5px;
            padding: 15px;
        }

        .file-item {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-left: 3px solid #667eea;
            padding-left: 12px;
            border-radius: 3px;
            font-size: 0.95em;
        }

        .code-viewer {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.9em;
            line-height: 1.4;
            margin: 10px 0;
        }

        .status {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
            font-weight: 600;
        }

        .status.show {
            display: block;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .analysis-box {
            background: #f8f9ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .analysis-box h5 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .warning {
            color: #856404;
            background-color: #fff3cd;
            padding: 10px;
            border-left: 3px solid #ffc107;
            margin: 5px 0;
            border-radius: 3px;
        }

        .success {
            color: #155724;
            background-color: #d4edda;
            padding: 10px;
            border-left: 3px solid #28a745;
            margin: 5px 0;
            border-radius: 3px;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            resize: vertical;
            margin: 10px 0;
        }

        .stat-box {
            display: inline-block;
            background: #f0f2ff;
            padding: 15px 20px;
            margin: 5px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .stat-box .label {
            color: #999;
            font-size: 0.9em;
        }

        .stat-box .value {
            color: #667eea;
            font-weight: 700;
            font-size: 1.3em;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            color: white;
            margin-top: 40px;
            padding: 20px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîì AI-Powered Website Decompiler Pro</h1>
        <p>Advanced APK, Dylib, JAR & File Analysis with AI Insights</p>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('decompiler')">üîß Decompilers</button>
            <button class="tab-btn" onclick="switchTab('tools')">üõ†Ô∏è Tools</button>
            <button class="tab-btn" onclick="switchTab('analyzer')">üîç Universal Analyzer</button>
            <button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
        </div>

        <div id="status" class="status"></div>

        <!-- DECOMPILERS TAB -->
        <div id="decompiler" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h2>üì± APK Decompiler</h2>
                    <div class="upload-area" onclick="document.getElementById('apkInput').click()">
                        <input type="file" id="apkInput" accept=".apk" onchange="handleFileUpload('apk', event)">
                        <div class="upload-text">üì≤ Click or drop APK file</div>
                        <div class="upload-subtext">Maximum 500MB | AI Analysis Enabled</div>
                    </div>
                    <button onclick="uploadAndDecompile('apk')" disabled id="apkBtn">Decompile APK</button>
                </div>

                <div class="card">
                    <h2>üîó Dylib Analyzer</h2>
                    <div class="upload-area" onclick="document.getElementById('dylibInput').click()">
                        <input type="file" id="dylibInput" accept=".dylib" onchange="handleFileUpload('dylib', event)">
                        <div class="upload-text">üìö Click or drop Dylib file</div>
                        <div class="upload-subtext">macOS Libraries | Full Analysis</div>
                    </div>
                    <button onclick="uploadAndDecompile('dylib')" disabled id="dylibBtn">Analyze Dylib</button>
                </div>

                <div class="card">
                    <h2>‚òï JAR Decompiler</h2>
                    <div class="upload-area" onclick="document.getElementById('jarInput').click()">
                        <input type="file" id="jarInput" accept=".jar" onchange="handleFileUpload('jar', event)">
                        <div class="upload-text">üì¶ Click or drop JAR file</div>
                        <div class="upload-subtext">Java Archives | Complete Extraction</div>
                    </div>
                    <button onclick="uploadAndDecompile('jar')" disabled id="jarBtn">Decompile JAR</button>
                </div>
                
                <div class="card">
                    <h2>üì¶ Batch Dylib Processor</h2>
                    <div class="upload-area" onclick="document.getElementById('batchDylibInput').click()">
                        <input type="file" id="batchDylibInput" accept=".dylib" multiple onchange="handleBatchFilesUpload('batch', event)">
                        <div class="upload-text">üì¶ Click or drop (1-10K files)</div>
                        <div class="upload-subtext">Extract backends, links, IPs | ZIP Report</div>
                    </div>
                    <button onclick="uploadAndDecompileBatch('batch')" disabled id="batchBtn">Process Batch</button>
                    <div id="batchProgress" style="margin-top: 10px; display: none;">
                        <div class="loading" style="display: inline-block;"></div>
                        <span id="batchProgressText">Processing...</span>
                    </div>
                </div>
            </div>

            <div id="results" class="results"></div>
        </div>

        <!-- TOOLS TAB -->
        <div id="tools" class="tab-content">
            <div class="card">
                <h2>‚ú® Code Beautifier & Formatter</h2>
                <div>
                    <label>Select Language:</label>
                    <select id="codeLanguage" style="padding: 8px; margin: 10px 0; width: 100%; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="js">JavaScript</option>
                        <option value="html">HTML</option>
                        <option value="css">CSS</option>
                    </select>
                </div>
                <textarea id="codeInput" placeholder="Paste your minified or unformatted code here..."></textarea>
                <button onclick="beautifyCode()">‚ú® Beautify & Format</button>
                <button onclick="copyToClipboard('beautifiedCode')">üìã Copy Result</button>
                <textarea id="beautifiedCode" placeholder="Formatted code will appear here..." readonly></textarea>
            </div>
        </div>

        <!-- ANALYZER TAB -->
        <div id="analyzer" class="tab-content">
            <div class="card">
                <h2>üåê Website Fetcher</h2>
                <input type="text" id="fetchUrl" placeholder="https://example.com" style="width:100%;padding:8px; box-sizing:border-box;">
                <button onclick="fetchWebsite()" style="margin-top:10px;">üîÑ Fetch & Analyze</button>
                <div id="fetchResult" class="results"></div>
            </div>
            <div class="card">
                <h2>üîç Universal File Analyzer</h2>
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" onchange="handleFileUpload('file', event)">
                    <div class="upload-text">üóÇÔ∏è Click or drop any file</div>
                    <div class="upload-subtext">Detects file type, size, entropy, and signatures</div>
                </div>
                <button onclick="uploadAndDecompile('file')" disabled id="fileBtn">Analyze File</button>
                <div id="analyzerResults" class="results"></div>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="settings" class="tab-content">
            <div class="card">
                <h2>‚öôÔ∏è Settings & Information</h2>
                <div class="result-section">
                    <h4>Server Status</h4>
                    <div id="serverStatus" class="stat-box">
                        <div class="label">Backend</div>
                        <div class="value" id="serverStatusValue">üî¥ Checking...</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Frontend</div>
                        <div class="value" style="color: green;">üü¢ Online</div>
                    </div>
                </div>

                <div class="result-section" style="margin-top: 20px;">
                    <h4>Application Info</h4>
                    <div style="color: #666; line-height: 1.8;">
                        <p><strong>Version:</strong> 1.0.0 Pro with AI</p>
                        <p><strong>Features:</strong> APK, Dylib, JAR Decompilation + AI Analysis</p>
                        <p><strong>Max File Size:</strong> 500MB</p>
                        <p><strong>Backend API:</strong> http://localhost:5000</p>
                        <p><strong>AI Analysis:</strong> ‚úÖ Enabled</p>
                    </div>
                </div>

                <div class="result-section" style="margin-top: 20px;">
                    <h4>Available Tools</h4>
                    <ul style="color: #666; line-height: 2; margin-left: 20px;">
                        <li>‚úÖ APK Decompilation with manifest extraction</li>
                        <li>‚úÖ Dylib analysis with string extraction</li>
                        <li>‚úÖ JAR decompilation with class listing</li>
                        <li>‚úÖ Universal file type detection</li>
                        <li>‚úÖ Code beautification (JS/HTML/CSS)</li>
                        <li>‚úÖ AI-powered security analysis</li>
                        <li>‚úÖ Library detection</li>
                        <li>‚úÖ File entropy calculation</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>AI-Powered Website Decompiler Pro | By GitHub Copilot | 2026</p>
        <p style="font-size: 0.9em; margin-top: 10px;">For educational and authorized use only</p>
    </div>

    <script>
        // Auto-detect API URL based on environment
        const API_URL = (() => {
            // Check for environment variable (for deployment)
            if (typeof window !== 'undefined' && window.API_URL) return window.API_URL;
            
            // Check localStorage (user can override)
            const stored = localStorage.getItem('API_URL');
            if (stored) return stored;
            
            // For production: use same domain
            if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                return `${window.location.protocol}//${window.location.hostname}${window.location.port ? ':' + window.location.port : ''}/api`;
            }
            
            // Default for local development
            return 'http://localhost:5000/api';
        })();
        
        const filesBucket = {};

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
        }

        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status show ${type}`;
        }

        function handleFileUpload(type, event) {
            const file = event.target.files[0];
            if (file) {
                filesBucket[type] = file;
                document.getElementById(type + 'Btn').disabled = false;
                showStatus(`üìÅ ${type.toUpperCase()}: ${file.name} selected (${formatBytes(file.size)})`, 'success');
            }
        }

        function handleBatchFilesUpload(type, event) {
            const files = event.target.files;
            if (files && files.length > 0) {
                filesBucket[type] = files;
                document.getElementById(type + 'Btn').disabled = false;
                showStatus(`üì¶ Batch: ${files.length} files selected | Total size: ~${formatBytes(Array.from(files).reduce((a, f) => a + f.size, 0))}`, 'success');
            }
        }

        async function uploadAndDecompile(type) {
            const file = filesBucket[type];
            if (!file) return;

            document.getElementById(type + 'Btn').disabled = true;
            showStatus(`‚è≥ Processing ${type.toUpperCase()}...`, 'info');

            try {
                const formData = new FormData();
                formData.append('file', file);

                const uploadRes = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!uploadRes.ok) throw new Error('Upload failed');
                const uploadData = await uploadRes.json();

                let endpoint;
                if (type === 'apk') endpoint = '/decompile/apk';
                else if (type === 'dylib') endpoint = '/decompile/dylib';
                else if (type === 'jar') endpoint = '/decompile/jar';
                else endpoint = '/decompile/analyze';

                const res = await fetch(`${API_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filePath: uploadData.path })
                });

                const data = await res.json();
                displayResults(data, type);
                showStatus(`‚úÖ ${data.message}`, 'success');
            } catch (error) {
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }

            document.getElementById(type + 'Btn').disabled = false;
        }

        async function uploadAndDecompileBatch(type) {
            const files = filesBucket[type];
            if (!files || files.length === 0) return;

            document.getElementById(type + 'Btn').disabled = true;
            document.getElementById('batchProgress').style.display = 'block';
            document.getElementById('batchProgressText').textContent = `Uploading ${files.length} files...`;
            showStatus(`‚è≥ Processing ${files.length} files...`, 'info');

            try {
                // Upload all files
                const filePaths = [];
                for (let i = 0; i < files.length; i++) {
                    const formData = new FormData();
                    formData.append('file', files[i]);

                    const uploadRes = await fetch(`${API_URL}/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!uploadRes.ok) throw new Error(`Upload failed for ${files[i].name}`);
                    const uploadData = await uploadRes.json();
                    filePaths.push(uploadData.path);
                    
                    document.getElementById('batchProgressText').textContent = `Uploaded ${i + 1}/${files.length} files`;
                }

                document.getElementById('batchProgressText').textContent = `Analyzing ${files.length} files...`;

                // Send all paths for batch processing
                const res = await fetch(`${API_URL}/decompile/dylib/batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filePaths })
                });

                const data = await res.json();
                displayBatchResults(data);
                showStatus(`‚úÖ Batch analysis complete! ${data.summary.successRate} success rate`, 'success');
            } catch (error) {
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }

            document.getElementById('batchProgress').style.display = 'none';
            document.getElementById(type + 'Btn').disabled = false;
        }

        function displayBatchResults(data) {
            const resultsDiv = document.getElementById('results');
            let html = `<h3>üìä Batch Analysis Report</h3>`;
            
            html += `<div class="result-section" style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">`;
            html += `<h4>üìà Summary</h4>`;
            html += `<div class="stat-box"><div class="label">Total Files</div><div class="value">${data.totalFiles}</div></div>`;
            html += `<div class="stat-box"><div class="label">Processed</div><div class="value">${data.processed}</div></div>`;
            html += `<div class="stat-box"><div class="label">Success Rate</div><div class="value">${data.summary.successRate}</div></div>`;
            html += `</div>`;

            // Display discovered backends
            if (data.allBackends && data.allBackends.length > 0) {
                html += `<div class="analysis-box" style="background-color: #fff3cd; border-left: 4px solid #ff9800;">`;
                html += `<h5>üîó Discovered Backends (${data.summary.uniqueBackends})</h5>`;
                html += `<div style="max-height: 300px; overflow-y: auto; margin-top: 10px;">`;
                data.allBackends.slice(0, 30).forEach(backend => {
                    html += `<div style="padding: 5px; border-bottom: 1px solid #f0f0f0; word-break: break-all; font-family: monospace; font-size: 0.85em;">üåê ${escapeHtml(backend)}</div>`;
                });
                if (data.allBackends.length > 30) {
                    html += `<div style="padding: 10px; color: #666; text-align: center; font-weight: 600;">... and ${data.allBackends.length - 30} more</div>`;
                }
                html += `</div></div>`;
            }
            // Display discovered API paths
            if (data.summary && data.summary.uniqueAPIs > 0) {
                html += `<div class="analysis-box" style="background-color: #e8f5e9; border-left: 4px solid #43a047;">`;
                html += `<h5>üîå Discovered API Paths (${data.summary.uniqueAPIs})</h5>`;
                if (data.allAPIs && data.allAPIs.length) {
                    html += `<div style="max-height: 200px; overflow-y: auto; margin-top: 10px;">`;
                    data.allAPIs.slice(0,30).forEach(api => {
                        html += `<div style="padding: 4px; font-family: monospace; font-size: 0.85em;">‚û°Ô∏è ${escapeHtml(api)}</div>`;
                    });
                    if (data.allAPIs.length > 30) {
                        html += `<div style="padding: 10px; color: #666; text-align: center; font-weight: 600;">... and ${data.allAPIs.length - 30} more</div>`;
                    }
                    html += `</div>`;
                }
                html += `</div>`;
            }

            // Display discovered domains
            if (data.allDomains && data.allDomains.length > 0) {
                html += `<div class="analysis-box" style="background-color: #e3f2fd; border-left: 4px solid #2196f3;">`;
                html += `<h5>üåç Discovered Domains (${data.summary.uniqueDomains})</h5>`;
                html += `<div style="max-height: 250px; overflow-y: auto; margin-top: 10px;">`;
                data.allDomains.slice(0, 25).forEach(domain => {
                    html += `<div style="padding: 5px; border-bottom: 1px solid #f0f0f0; font-family: monospace; font-size: 0.85em;">üìç ${escapeHtml(domain)}</div>`;
                });
                if (data.allDomains.length > 25) {
                    html += `<div style="padding: 10px; color: #666; text-align: center; font-weight: 600;">... and ${data.allDomains.length - 25} more</div>`;
                }
                html += `</div></div>`;
            }

            // Display discovered IPs
            if (data.allIPs && data.allIPs.length > 0) {
                html += `<div class="analysis-box" style="background-color: #f3e5f5; border-left: 4px solid #9c27b0;">`;
                html += `<h5>üîí Discovered IP Addresses (${data.summary.uniqueIPs})</h5>`;
                html += `<div style="max-height: 250px; overflow-y: auto; margin-top: 10px;">`;
                data.allIPs.slice(0, 25).forEach(ip => {
                    html += `<div style="padding: 5px; border-bottom: 1px solid #f0f0f0; font-family: monospace; font-size: 0.85em;">üì° ${ip}</div>`;
                });
                if (data.allIPs.length > 25) {
                    html += `<div style="padding: 10px; color: #666; text-align: center; font-weight: 600;">... and ${data.allIPs.length - 25} more</div>`;
                }
                html += `</div></div>`;
            }

            // Download batch ZIP
            if (data.zipPath) {
                html += `<div style="margin-top: 20px; text-align: center;">`;
                html += `<button onclick="downloadDylibProject('${data.zipPath}', '${data.batchId}-report.zip')" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 1em;">üì• Download Batch Report (ZIP)</button>`;
                html += `</div>`;
                html += `<div style="color:#666; font-size:0.9em; margin-top:10px; text-align:center;">(see "sampleRequests" and "networkCalls" fields inside the JSON)</div>`;
            }

            resultsDiv.innerHTML = html;
            resultsDiv.classList.add('show');
        }

        function displayResults(data, type) {
            const resultsDiv = type === 'file' ? document.getElementById('analyzerResults') : document.getElementById('results');
            let html = '<h3>‚úÖ Analysis Results</h3>';

            if (data.type === 'APK' || data.type === 'JAR') {
                html += `<div class="result-section">`;
                html += `<h4>${data.type} Information</h4>`;
                html += `<div class="stat-box"><div class="label">Total Files</div><div class="value">${data.totalFiles}</div></div>`;
                if (data.type === 'JAR') html += `<div class="stat-box"><div class="label">Classes</div><div class="value">${data.classFiles || 0}</div></div>`;
                html += `</div>`;

                if (data.manifest) {
                    html += `<div class="result-section"><h4>Manifest</h4>`;
                    html += `<div class="code-viewer">${escapeHtml(data.manifest.substring(0, 1000))}</div></div>`;
                }

                if (data.files && data.files.length > 0) {
                    html += `<div class="result-section"><h4>Files (showing first 50)</h4>`;
                    html += `<div class="file-list">`;
                    data.files.slice(0, 50).forEach(f => {
                        html += `<div class="file-item">${f.name} <span style="color: #999; font-size: 0.9em;">(${formatBytes(f.size)})</span></div>`;
                    });
                    html += `</div></div>`;
                }
            } else if (data.type === 'Dylib') {
                // Header with main stats
                html += `<div class="result-section">`;
                html += `<h4>üéØ Smart AI Dylib Decompilation</h4>`;
                if (data.analysis_data) {
                    html += `<div class="stat-box"><div class="label">Classes Detected</div><div class="value">${data.analysis_data.classes_detected || 0}</div></div>`;
                    html += `<div class="stat-box"><div class="label">Methods Found</div><div class="value">${data.analysis_data.methods_detected || 0}</div></div>`;
                    html += `<div class="stat-box"><div class="label">Strings Extracted</div><div class="value">${data.analysis_data.strings_found || 0}</div></div>`;
                    html += `<div class="stat-box"><div class="label">Dependencies</div><div class="value">${data.analysis_data.imports_detected || 0}</div></div>`;
                } else {
                    html += `<div class="stat-box"><div class="label">Architecture</div><div class="value">${data.machOHeader?.architecture || 'Unknown'}</div></div>`;
                }
                html += `</div>`;

                // AI Security Analysis Section
                if (data.security) {
                    html += `<div class="analysis-box" style="background-color: #fff3cd; border-left: 4px solid #ff9800;">`;
                    html += `<h5>üîç AI Security Analysis</h5>`;
                    if (data.security.warnings && data.security.warnings.length > 0) {
                        html += `<div style="margin: 10px 0;">`;
                        data.security.warnings.forEach(w => {
                            html += `<div style="padding: 5px; color: #d32f2f; margin: 5px 0;">‚ö†Ô∏è ${w}</div>`;
                        });
                        html += `</div>`;
                    }
                    if (data.security.detection_confidence) {
                        html += `<div style="margin-top: 10px;"><strong>Detection Confidence:</strong> ${Math.round(data.security.detection_confidence)}%</div>`;
                    }
                    if (data.security.riskScore) {
                        html += `<div style="color: #667eea; font-weight: 600; margin-top: 5px;">Risk Score: ${data.security.riskScore}</div>`;
                    }
                    if (data.security.sampleRequests && data.security.sampleRequests.length) {
                        html += `<div style="margin-top:15px;"><h6>üíª Sample Network Requests</h6>`;
                        data.security.sampleRequests.forEach(sn => {
                            html += `<pre style="background:#f5f5f5; padding:8px; border-radius:4px; font-size:0.85em;">${escapeHtml(sn)}</pre>`;
                        });
                        html += `</div>`;
                    }
                    if (data.security.networkLibraries && data.security.networkLibraries.length) {
                        html += `<div style="margin-top:15px;"><h6>üì¶ Detected Network Libraries</h6><div style="font-family:monospace;">`;
                        data.security.networkLibraries.forEach(lib => {
                            html += `<span style="margin-right:10px;">${escapeHtml(lib)}</span>`;
                        });
                        html += `</div></div>`;
                    }
                    if (data.security.networkCalls && data.security.networkCalls.length) {
                        html += `<div style="margin-top:15px;"><h6>üîó Exposed Calls (fetch/axios)</h6>`;
                        data.security.networkCalls.forEach(call => {
                            html += `<pre style="background:#fafafa; padding:6px; border-radius:3px; font-size:0.85em;">${escapeHtml(call)}</pre>`;
                        });
                        html += `</div>`;
                    }
                    html += `</div>`;
                }

                // Network Analysis Section
                if (data.network_analysis) {
                    html += `<div class="analysis-box" style="background-color: #e8f5e9; border-left: 4px solid #4caf50;">`;
                    html += `<h5>üåê Network & Backend Analysis</h5>`;
                    
                    // Backends
                    if (data.network_analysis.backends && data.network_analysis.backends.length > 0) {
                        html += `<div style="margin-top: 10px;">`;
                        html += `<strong>Backends Found (${data.network_analysis.backends.length}):</strong>`;
                        html += `<div style="max-height: 200px; overflow-y: auto; margin-top: 5px;">`;
                        data.network_analysis.backends.forEach(b => {
                            html += `<div style="padding: 5px; font-family: monospace; font-size: 0.85em; background: white; margin: 3px 0; padding: 5px; border-radius: 3px;">üåê ${escapeHtml(b)}</div>`;
                        });
                        html += `</div></div>`;
                    }
                    
                    // APIs
                    if (data.network_analysis.apis && data.network_analysis.apis.length > 0) {
                        html += `<div style="margin-top: 10px;">`;
                        html += `<strong>API Endpoints Found (${data.network_analysis.apis.length}):</strong>`;
                        html += `<div style="max-height: 150px; overflow-y: auto; margin-top: 5px;">`;
                        data.network_analysis.apis.forEach(a => {
                            html += `<div style="padding: 4px; font-family: monospace; font-size: 0.85em; background: white; margin: 2px 0; padding: 4px; border-radius: 3px;">üîå ${escapeHtml(a)}</div>`;
                        });
                        html += `</div></div>`;
                    }
                    
                    // Domains
                    if (data.network_analysis.domains && data.network_analysis.domains.length > 0) {
                        html += `<div style="margin-top: 10px;">`;
                        html += `<strong>Domains (${data.network_analysis.domains.length}):</strong>`;
                        html += `<div style="max-height: 120px; overflow-y: auto; margin-top: 5px;">`;
                        data.network_analysis.domains.forEach(d => {
                            html += `<span style="display: inline-block; padding: 4px 8px; margin: 3px; background: #fff9c4; border-radius: 3px; font-size: 0.85em;">üîó ${escapeHtml(d)}</span>`;
                        });
                        html += `</div></div>`;
                    }
                    
                    // IPs
                    if (data.network_analysis.ips && data.network_analysis.ips.length > 0) {
                        html += `<div style="margin-top: 10px;">`;
                        html += `<strong>IP Addresses (${data.network_analysis.ips.length}):</strong>`;
                        html += `<div style="max-height: 120px; overflow-y: auto; margin-top: 5px;">`;
                        data.network_analysis.ips.forEach(ip => {
                            html += `<span style="display: inline-block; padding: 4px 8px; margin: 3px; background: #ffccbc; border-radius: 3px; font-size: 0.85em;">üîí ${escapeHtml(ip)}</span>`;
                        });
                        html += `</div></div>`;
                    }
                    
                    html += `</div>`;
                }

                // Extracted Classes
                if (data.extracted && data.extracted.classes && data.extracted.classes.length > 0) {
                    html += `<div class="analysis-box">`;
                    html += `<h5>üì¶ Detected Classes (${data.extracted.classes.length})</h5>`;
                    html += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">`;
                    data.extracted.classes.slice(0, 12).forEach(cls => {
                        html += `<div style="padding: 8px; background: #f5f5f5; border-radius: 5px; font-family: monospace; font-size: 0.9em;">üì¶ ${cls}</div>`;
                    });
                    html += `</div>`;
                    html += `</div>`;
                }

                // Extracted Methods
                if (data.extracted && data.extracted.methods && data.extracted.methods.length > 0) {
                    html += `<div class="analysis-box">`;
                    html += `<h5>‚öôÔ∏è Detected Methods (${data.extracted.methods.length})</h5>`;
                    html += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-top: 10px;">`;
                    data.extracted.methods.slice(0, 20).forEach(m => {
                        const type = m.type ? m.type.toUpperCase() : 'METHOD';
                        html += `<div style="padding: 8px; background: #e8f5e9; border-radius: 5px; font-family: monospace; font-size: 0.85em;">‚öôÔ∏è <strong>${m.name || 'unknown'}</strong> <span style="color: #666;">[${type}]</span></div>`;
                    });
                    html += `</div>`;
                    html += `</div>`;
                }

                // Dependencies
                if (data.extracted && data.extracted.imports && data.extracted.imports.length > 0) {
                    html += `<div class="analysis-box" style="background-color: #f3e5f5;">`;
                    html += `<h5>üìö Dependencies & Imports (${data.extracted.imports.length})</h5>`;
                    html += `<div style="margin-top: 10px; line-height: 1.8;">`;
                    data.extracted.imports.slice(0, 15).forEach(imp => {
                        html += `<div>üîó <code style="background: #f5f5f5; padding: 3px 6px; border-radius: 3px;">${imp}</code></div>`;
                    });
                    html += `</div></div>`;
                }

                // Generated Source Code Files
                if (data.generatedFiles && data.generatedFiles.length > 0) {
                    html += `<div class="analysis-box" style="background-color: #e3f2fd; border-left: 4px solid #2196f3;">`;
                    html += `<h5>üìù Generated Objective-C Source Code</h5>`;
                    html += `<p style="color: #666; margin: 10px 0;">Complete buildable project with:</p>`;
                    html += `<ul style="margin-left: 20px; margin-top: 10px; color: #333;">`;
                    data.generatedFiles.forEach(file => {
                        html += `<li style="margin: 5px 0;">${file}</li>`;
                    });
                    html += `</ul>`;
                    if (data.downloads && data.downloads.zipPath) {
                        html += `<button onclick="downloadDylibProject('${data.downloads.zipPath}', '${data.downloads.zip}')" style="margin-top: 15px; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 1em;">üì• Download Full Project (ZIP)</button>`;
                    }
                    html += `</div>`;
                }

                // Deobfuscated Strings
                if (data.extracted && data.extracted.classes && data.extracted.classes.length > 0) {
                    html += `<div class="result-section"><h4>üîë Sample Extracted Strings</h4>`;
                    html += `<div class="code-viewer" style="max-height: 300px; overflow-y: auto;">`;
                    data.extracted.classes.slice(0, 30).forEach((str, i) => {
                        html += `<div>${i+1}. ${escapeHtml(str)}</div>`;
                    });
                    html += `</div></div>`;
                }
            
            } else {
                html += `<div class="result-section">`;
                html += `<div class="stat-box"><div class="label">File Type</div><div class="value">${data.type}</div></div>`;
                html += `<div class="stat-box"><div class="label">Size</div><div class="value">${data.sizeFormatted}</div></div>`;
                html += `<div class="stat-box"><div class="label">Entropy</div><div class="value">${data.entropy}</div></div>`;
                if (data.signatures && data.signatures.length > 0) {
                    html += `<div class="stat-box"><div class="label">Signatures</div><div class="value">${data.signatures.join(', ')}</div></div>`;
                }
                html += `</div>`;
            }

            resultsDiv.innerHTML = html;
            resultsDiv.classList.add('show');
        }

        async function beautifyCode() {
            const code = document.getElementById('codeInput').value;
            const language = document.getElementById('codeLanguage').value;

            if (!code.trim()) {
                showStatus('‚ö†Ô∏è Please enter code to beautify', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/decompile/beautify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, language })
                });

                const data = await res.json();
                document.getElementById('beautifiedCode').value = data.beautified;
                showStatus(`‚úÖ Code formatted: ${data.statistics.lines} lines`, 'success');
            } catch (error) {
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function copyToClipboard(id) {
            const el = document.getElementById(id);
            el.select();
            document.execCommand('copy');
            showStatus('üìã Copied to clipboard!', 'success');
        }

        function formatBytes(bytes) {
            const sizes = ['B', 'KB', 'MB'];
            if (bytes === 0) return '0 B';
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + sizes[i];
        }

        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, c => map[c]);
        }

        async function fetchWebsite() {
            const url = document.getElementById('fetchUrl').value.trim();
            if (!url) {
                showStatus('‚ö†Ô∏è Please enter a URL', 'error');
                return;
            }
            showStatus('üåç Fetching website...', 'info');
            try {
                const res = await fetch(`${API_URL}/fetch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await res.json();
                let html = `<h4>URL: ${escapeHtml(data.url)}</h4>`;
                html += `<div style="max-height:400px; overflow:auto; background:#f5f5f5; padding:10px; white-space:pre-wrap;">${escapeHtml(data.content || '').substring(0,2000)}</div>`;
                document.getElementById('fetchResult').innerHTML = html;
                showStatus('‚úÖ Website fetched', 'success');
            } catch (err) {
                showStatus(`‚ùå Fetch error: ${err.message}`, 'error');
            }
        }

        async function downloadDylibProject(zipPath, filename) {
            try {
                showStatus('üì• Downloading dylib project...' , 'info');
                const res = await fetch(`${API_URL}/decompile/dylib/download`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ zipPath })
                });

                if (!res.ok) {
                    throw new Error('Download failed');
                }

                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename || 'dylib-project.zip';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showStatus('‚úÖ Project downloaded successfully! Check your downloads folder.', 'success');
            } catch (error) {
                showStatus(`‚ùå Download error: ${error.message}`, 'error');
            }
        }

        window.addEventListener('load', async () => {
            try {
                const res = await fetch(`${API_URL}/health`);
                if (res.ok) {
                    document.getElementById('serverStatusValue').innerHTML = 'üü¢ Online';
                    document.getElementById('serverStatusValue').style.color = 'green';
                }
            } catch {
                document.getElementById('serverStatusValue').innerHTML = 'üî¥ Offline';
            }
        });
    </script>
</body>
</html>
